---
doc: |
  Create qemu guest, transfer SPDK .tgz source and invoke autorun

  * Create qemu guest, and start it, using a system_image
  * Transfer and unpack SPDK source to/in qemu guest
  * Create auto.conf for testing (unittest + nvme)
  * Invoke autorun.sh
  * Retrieve autorun output
  * Shut down qemu guest

steps:
- name: guest_initialize
  uses: qemu.guest_initialize
  with:
    system_image_name: fedora-40-x86_64
    guest_name: generic-bios-kvm-x86_64

- name: guest_start
  uses: qemu_guest_start_custom_nvme
  with:
    guest_name: generic-bios-kvm-x86_64

- name: guest_check
  run: |
    hostname
    uname -a

- name: tgz_transfer
  uses: core.put
  with:
    src: "{{ local.env.REPOSITORY_TARBALL_PATH }}"
    dst: /tmp/repository.tar.gz

- name: ci_configs_transfer
  uses: core.put
  with:
    src: "{{ local.env.CI_CFGS_REPOSITORY_PATH }}"
    dst: /opt/configs

- name: tgz_unpack
  run: |
    mkdir -p /opt/spdk
    tar xzf /tmp/repository.tar.gz -C /opt/spdk
    git config --global --add safe.directory /opt/spdk

- name: autorun_unittest
  run: |
    mkdir -p /opt/output/unittest
    output_dir=/opt/output/unittest /opt/spdk/autorun.sh /opt/configs/unittest.conf

- name: autorun_nvme
  run: |
    mkdir -p /opt/output/nvme
    output_dir=/opt/output/nvme /opt/spdk/autorun.sh /opt/configs/nvme.conf

- name: autobuild-external-vm-autotest
  run: |
    mkdir -p /opt/output/autobuild-external-vm-autotest
    output_dir=/opt/output/autobuild-external-vm-autotest /opt/spdk/autorun.sh /opt/configs/autobuild-external-vm-autotest.conf

- name: blobfs-phy-autotest
  run: |
    mkdir -p /opt/output/blobfs-phy-autotest
    output_dir=/opt/output/blobfs-phy-autotest /opt/spdk/autorun.sh /opt/configs/blobfs-phy-autotest.conf

- name: crypto-phy-autotest
  run: |
    mkdir -p /opt/output/crypto-phy-autotest
    output_dir=/opt/output/crypto-phy-autotest /opt/spdk/autorun.sh /opt/configs/crypto-phy-autotest.conf

- name: freebsd-vm-autotest
  run: |
    mkdir -p /opt/output/freebsd-vm-autotest
    output_dir=/opt/output/freebsd-vm-autotest /opt/spdk/autorun.sh /opt/configs/freebsd-vm-autotest.conf

- name: iscsi-uring-vm-autotest
  run: |
    mkdir -p /opt/output/iscsi-uring-vm-autotest
    output_dir=/opt/output/iscsi-uring-vm-autotest /opt/spdk/autorun.sh /opt/configs/iscsi-uring-vm-autotest.conf

- name: iscsi-vm-autotest
  run: |
    mkdir -p /opt/output/iscsi-vm-autotest
    output_dir=/opt/output/iscsi-vm-autotest /opt/spdk/autorun.sh /opt/configs/iscsi-vm-autotest.conf

- name: lvol-vm-autotest
  run: |
    mkdir -p /opt/output/lvol-vm-autotest
    output_dir=/opt/output/lvol-vm-autotest /opt/spdk/autorun.sh /opt/configs/lvol-vm-autotest.conf

- name: nvme-cmb-pmr-vm-autotest
  run: |
    mkdir -p /opt/output/nvme-cmb-pmr-vm-autotest
    output_dir=/opt/output/nvme-cmb-pmr-vm-autotest /opt/spdk/autorun.sh /opt/configs/nvme-cmb-pmr-vm-autotest.conf

- name: nvme-phy-autotest
  run: |
    mkdir -p /opt/output/nvme-phy-autotest
    output_dir=/opt/output/nvme-phy-autotest /opt/spdk/autorun.sh /opt/configs/nvme-phy-autotest.conf

- name: nvme-vm-autotest
  run: |
    mkdir -p /opt/output/nvme-vm-autotest
    output_dir=/opt/output/nvme-vm-autotest /opt/spdk/autorun.sh /opt/configs/nvme-vm-autotest.conf

- name: nvmf-phy-autotest
  run: |
    mkdir -p /opt/output/nvmf-phy-autotest
    output_dir=/opt/output/nvmf-phy-autotest /opt/spdk/autorun.sh /opt/configs/nvmf-phy-autotest.conf

- name: nvmf-tcp-phy-autotest
  run: |
    mkdir -p /opt/output/nvmf-tcp-phy-autotest
    output_dir=/opt/output/nvmf-tcp-phy-autotest /opt/spdk/autorun.sh /opt/configs/nvmf-tcp-phy-autotest.conf

- name: nvmf-tcp-uring-vm-autotest
  run: |
    mkdir -p /opt/output/nvmf-tcp-uring-vm-autotest
    output_dir=/opt/output/nvmf-tcp-uring-vm-autotest /opt/spdk/autorun.sh /opt/configs/nvmf-tcp-uring-vm-autotest.conf

- name: nvmf-tcp-vm-autotest
  run: |
    mkdir -p /opt/output/nvmf-tcp-vm-autotest
    output_dir=/opt/output/nvmf-tcp-vm-autotest /opt/spdk/autorun.sh /opt/configs/nvmf-tcp-vm-autotest.conf

- name: rocky9-vm-autotest
  run: |
    mkdir -p /opt/output/rocky9-vm-autotest
    output_dir=/opt/output/rocky9-vm-autotest /opt/spdk/autorun.sh /opt/configs/rocky9-vm-autotest.conf

- name: short-fuzz-phy-autotest
  run: |
    mkdir -p /opt/output/short-fuzz-phy-autotest
    output_dir=/opt/output/short-fuzz-phy-autotest /opt/spdk/autorun.sh /opt/configs/short-fuzz-phy-autotest.conf

- name: ubuntu22-vm-autotest
  run: |
    mkdir -p /opt/output/ubuntu22-vm-autotest
    output_dir=/opt/output/ubuntu22-vm-autotest /opt/spdk/autorun.sh /opt/configs/ubuntu22-vm-autotest.conf

- name: ubuntu24-vg-autotest
  run: |
    mkdir -p /opt/output/ubuntu24-vg-autotest
    output_dir=/opt/output/ubuntu24-vg-autotest /opt/spdk/autorun.sh /opt/configs/ubuntu24-vg-autotest.conf

- name: vfio-user-phy-autotest
  run: |
    mkdir -p /opt/output/vfio-user-phy-autotest
    output_dir=/opt/output/vfio-user-phy-autotest /opt/spdk/autorun.sh /opt/configs/vfio-user-phy-autotest.conf

- name: vhost-initiator-vm-autotest
  run: |
    mkdir -p /opt/output/vhost-initiator-vm-autotest
    output_dir=/opt/output/vhost-initiator-vm-autotest /opt/spdk/autorun.sh /opt/configs/vhost-initiator-vm-autotest.conf

- name: vhost-phy-autotest
  run: |
    mkdir -p /opt/output/vhost-phy-autotest
    output_dir=/opt/output/vhost-phy-autotest /opt/spdk/autorun.sh /opt/configs/vhost-phy-autotest.conf

- name: zns-vm-autotest
  run: |
    mkdir -p /opt/output/zns-vm-autotest
    output_dir=/opt/output/zns-vm-autotest /opt/spdk/autorun.sh /opt/configs/zns-vm-autotest.conf

- name: packaging-docker-autotest
  run: |
    mkdir -p /opt/output/packaging-docker-autotest
    output_dir=/opt/output/packaging-docker-autotest rootdir=/opt/spdk source "/opt/spdk/test/common/autobuild_common.sh" "/opt/configs/packaging-docker-autotest.conf"
    build_packaging

- name: release-build-clang-docker-autotest
  run: |
    mkdir -p /opt/output/release-build-clang-docker-autotest
    output_dir=/opt/output/release-build-clang-docker-autotest rootdir=/opt/spdk source "/opt/spdk/test/common/autobuild_common.sh" "/opt/configs/release-build-clang-docker-autotest.conf"
    export CC=/usr/bin/clang CXX=/usr/bin/clang++

- name: release-build-main-docker-autotest
  run: |
    mkdir -p /opt/output/release-build-main-docker-autotest
    output_dir=/opt/output/release-build-main-docker-autotest rootdir=/opt/spdk source "/opt/spdk/test/common/autobuild_common.sh" "/opt/configs/release-build-main-docker-autotest.conf"
    build_release

- name: scan-build-docker-autotest
  run: |
    mkdir -p /opt/output/scan-build-docker-autotest
    output_dir=/opt/output/scan-build-docker-autotest rootdir=/opt/spdk source "/opt/spdk/test/common/autobuild_common.sh" "/opt/configs/scan-build-docker-autotest.conf"
    ocf_precompile
    scanbuild_make

- name: unittest-valgrind-docker-autotest
  run: |
    mkdir -p /opt/output/unittest-valgrind-docker-autotest
    output_dir=/opt/output/unittest-valgrind-docker-autotest rootdir=/opt/spdk source "/opt/spdk/test/common/autobuild_common.sh" "/opt/configs/unittest-valgrind-docker-autotest.conf"
    ocf_precompile
    unittest_build
    /opt/spdk/test/unit/unittest.sh

- name: unittest-clang-docker-autotest
  run: |
    mkdir -p /opt/output/unittest-clang-docker-autotest
    output_dir=/opt/output/unittest-clang-docker-autotest rootdir=/opt/spdk source "/opt/spdk/test/common/autobuild_common.sh" "/opt/configs/unittest-clang-docker-autotest.conf"
    export CC=/usr/bin/clang CXX=/usr/bin/clang++

- name: unittest-main-docker-autotest
  run: |
    mkdir -p /opt/output/unittest-main-docker-autotest
    output_dir=/opt/output/unittest-main-docker-autotest rootdir=/opt/spdk source "/opt/spdk/test/common/autobuild_common.sh" "/opt/configs/unittest-main-docker-autotest.conf"
    ocf_precompile
    unittest_build
    /opt/spdk/test/unit/unittest.sh

- name: build-files-docker-autotest
  run: |
    touch empty.conf
    mkdir -p /opt/output/build-files-docker-autotest
    output_dir=/opt/output/build-files-docker-autotest rootdir=/opt/spdk source "/opt/spdk/test/common/autobuild_common.sh" "./empty.conf"
    build_files
    dpdk_pci_api

- name: check-format-docker-autotest
  run: |
    touch empty.conf
    mkdir -p /opt/output/check-format-docker-autotest
    output_dir=/opt/output/check-format-docker-autotest rootdir=/opt/spdk source "/opt/spdk/test/common/autobuild_common.sh" "./empty.conf"
    CHECK_FORMAT_ONLY_DIFF=yes check_format

- name: check-so-deps-docker-autotest
  run: |
    touch empty.conf
    mkdir -p /opt/output/check-so-deps-docker-autotest
    output_dir=/opt/output/check-so-deps-docker-autotest rootdir=/opt/spdk source "/opt/spdk/test/common/autobuild_common.sh" "./empty.conf"
    ocf_precompile
    SPDK_ABI_DIR=/opt/spdk-abi check_so_deps # TODO: pull spdk-abi repo

- name: doc-docker-autotest
  run: |
    touch empty.conf
    mkdir -p /opt/output/doc-docker-autotest
    output_dir=/opt/output/doc-docker-autotest rootdir=/opt/spdk source "/opt/spdk/test/common/autobuild_common.sh" "./empty.conf"
    build_doc

- name: output_listing
  run: |
    ls /opt
    ls /opt/output

- name: retrieve_autorun_output
  uses: core.get
  with:
    src: /opt/output
    dst: /tmp/autorun_output

- name: guest_shutdown
  run: |
    systemctl poweroff
